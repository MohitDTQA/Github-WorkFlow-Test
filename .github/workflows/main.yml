# # name: Playwright CI/CD

# on:
#   push:
#     branches: [ main, master ]
#   pull_request:
#     branches: [ main, master ]

# permissions:
#   contents: read
#   pages: write
#   id-token: write

# jobs:
#   test-and-deploy:
#     runs-on: ubuntu-latest
#     timeout-minutes: 60

#     environment:
#       name: github-pages
#       url: ${{ steps.deployment.outputs.page_url }}

#     steps:
#       # 1Ô∏è‚É£ Checkout repository
#       - name: Checkout repo
#         uses: actions/checkout@v4

#       # 2Ô∏è‚É£ Setup Node.js
#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: lts/*

#       # 3Ô∏è‚É£ Install dependencies
#       - name: Install dependencies
#         run: npm ci

#       # 4Ô∏è‚É£ Install Playwright browsers
#       - name: Install Playwright browsers
#         run: npx playwright install --with-deps

#       # 5Ô∏è‚É£ Install Allure CLI
#       - name: Install Allure CLI
#         run: npm install -D allure-commandline

#       # 6Ô∏è‚É£ Run Playwright tests
#       - name: Run Playwright tests
#         run: xvfb-run -a npx playwright test
#         continue-on-error: true

#       # 7Ô∏è‚É£ Generate Allure HTML report
#       - name: Generate Allure report
#         if: always()
#         run: npx allure-commandline generate results_reports/allure-results --clean -o results_reports/allure-report

#       # 8Ô∏è‚É£ Upload Playwright test-results artifacts
#       - name: Upload Playwright test-results
#         if: always()
#         uses: actions/upload-artifact@v4
#         with:
#           name: playwright-test-results
#           path: results_reports/test-results/
#           retention-days: 30

#       # 8Ô∏è‚É£b Upload custom artifacts (screenshots/videos)
#       - name: Upload custom artifacts
#         if: always()
#         uses: actions/upload-artifact@v4
#         with:
#           name: custom-artifacts
#           path: artifacts/
#           retention-days: 30

#       # 9Ô∏è‚É£ Upload Playwright HTML report
#       - name: Upload Playwright report artifact
#         if: always()
#         uses: actions/upload-artifact@v4
#         with:
#           name: playwright-report
#           path: results_reports/playwright-report/
#           retention-days: 30

#       # üîü Upload Allure report
#       - name: Upload Allure report artifact
#         if: always()
#         uses: actions/upload-artifact@v4
#         with:
#           name: allure-report
#           path: results_reports/allure-report/
#           retention-days: 30

#       # 1Ô∏è‚É£1Ô∏è‚É£ Prepare GitHub Pages content (Reports + Artifacts)
#       - name: Prepare Pages content
#         if: always()
#         run: |
#           mkdir -p pages/playwright
#           mkdir -p pages/allure
#           mkdir -p pages/artifacts

#           # Copy reports
#           cp -r results_reports/playwright-report/* pages/playwright/
#           cp -r results_reports/allure-report/* pages/allure/

#           # Copy artifacts from root/artifacts/ directory
#           if [ -d "artifacts" ]; then
#             cp -r artifacts/* pages/artifacts/
#           fi

#           # Copy test-results if exists
#           if [ -d "results_reports/test-results" ]; then
#             cp -r results_reports/test-results/* pages/artifacts/
#           fi

#           # Create artifact index page with screenshot/video gallery
#           cat <<'EOF' > pages/artifacts/index.html
#           <!DOCTYPE html>
#           <html>
#             <head>
#               <meta charset="UTF-8" />
#               <title>Test Artifacts</title>
#               <style>
#                 body {
#                   font-family: Arial, sans-serif;
#                   padding: 40px;
#                   background: #f5f5f5;
#                 }
#                 h1 {
#                   margin-bottom: 30px;
#                   color: #333;
#                 }
#                 .artifacts-grid {
#                   display: grid;
#                   grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
#                   gap: 20px;
#                   margin-top: 20px;
#                 }
#                 .artifact-card {
#                   background: white;
#                   border-radius: 8px;
#                   padding: 15px;
#                   box-shadow: 0 2px 8px rgba(0,0,0,0.1);
#                 }
#                 .artifact-card h3 {
#                   margin: 0 0 10px 0;
#                   font-size: 14px;
#                   color: #666;
#                   word-break: break-all;
#                 }
#                 .artifact-card img {
#                   width: 100%;
#                   height: auto;
#                   border-radius: 4px;
#                   cursor: pointer;
#                   transition: transform 0.2s;
#                 }
#                 .artifact-card img:hover {
#                   transform: scale(1.02);
#                 }
#                 .artifact-card video {
#                   width: 100%;
#                   height: auto;
#                   border-radius: 4px;
#                 }
#                 .modal {
#                   display: none;
#                   position: fixed;
#                   z-index: 1000;
#                   left: 0;
#                   top: 0;
#                   width: 100%;
#                   height: 100%;
#                   background-color: rgba(0,0,0,0.9);
#                 }
#                 .modal-content {
#                   margin: auto;
#                   display: block;
#                   max-width: 90%;
#                   max-height: 90%;
#                   position: absolute;
#                   top: 50%;
#                   left: 50%;
#                   transform: translate(-50%, -50%);
#                 }
#                 .close {
#                   position: absolute;
#                   top: 15px;
#                   right: 35px;
#                   color: #f1f1f1;
#                   font-size: 40px;
#                   font-weight: bold;
#                   cursor: pointer;
#                 }
#                 .no-artifacts {
#                   text-align: center;
#                   color: #999;
#                   padding: 40px;
#                 }
#               </style>
#             </head>
#             <body>
#               <h1>Test Artifacts</h1>
#               <div id="artifacts-container" class="artifacts-grid"></div>
#               <div class="no-artifacts" id="no-artifacts" style="display:none;">
#                 No artifacts found
#               </div>

#               <div id="imageModal" class="modal">
#                 <span class="close">&times;</span>
#                 <img class="modal-content" id="modalImage">
#               </div>

#               <script>
#                 async function loadArtifacts() {
#                   const container = document.getElementById('artifacts-container');
#                   const noArtifacts = document.getElementById('no-artifacts');
                  
#                   try {
#                     const response = await fetch('artifacts-list.json');
#                     const data = await response.json();
                    
#                     if (data.screenshots.length === 0 && data.videos.length === 0) {
#                       noArtifacts.style.display = 'block';
#                       return;
#                     }

#                     // Display screenshots
#                     data.screenshots.forEach(screenshot => {
#                       const card = document.createElement('div');
#                       card.className = 'artifact-card';
#                       card.innerHTML = `
#                         <h3>üì∏ ${screenshot.name}</h3>
#                         <img src="${screenshot.path}" alt="${screenshot.name}" onclick="openModal(this.src)">
#                       `;
#                       container.appendChild(card);
#                     });

#                     // Display videos
#                     data.videos.forEach(video => {
#                       const card = document.createElement('div');
#                       card.className = 'artifact-card';
#                       card.innerHTML = `
#                         <h3>üé• ${video.name}</h3>
#                         <video controls>
#                           <source src="${video.path}" type="video/webm">
#                           Your browser does not support the video tag.
#                         </video>
#                       `;
#                       container.appendChild(card);
#                     });
#                   } catch (error) {
#                     noArtifacts.style.display = 'block';
#                   }
#                 }

#                 function openModal(src) {
#                   const modal = document.getElementById('imageModal');
#                   const modalImg = document.getElementById('modalImage');
#                   modal.style.display = 'block';
#                   modalImg.src = src;
#                 }

#                 document.querySelector('.close').onclick = function() {
#                   document.getElementById('imageModal').style.display = 'none';
#                 }

#                 window.onclick = function(event) {
#                   const modal = document.getElementById('imageModal');
#                   if (event.target == modal) {
#                     modal.style.display = 'none';
#                   }
#                 }

#                 loadArtifacts();
#               </script>
#             </body>
#           </html>
#           EOF

#           # Generate artifacts list JSON
#           cat <<'EOF' > pages/artifacts/generate-list.sh
#           #!/bin/bash
#           cd "$(dirname "$0")"
          
#           echo '{'
#           echo '  "screenshots": ['
#           first=true
#           find . -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" \) | while read -r file; do
#             filename=$(basename "$file")
#             filepath="${file#./}"
#             if [ "$first" = true ]; then
#               first=false
#             else
#               echo ','
#             fi
#             echo -n "    {\"name\": \"$filename\", \"path\": \"$filepath\"}"
#           done
#           echo ''
#           echo '  ],'
#           echo '  "videos": ['
#           first=true
#           find . -type f \( -name "*.webm" -o -name "*.mp4" \) | while read -r file; do
#             filename=$(basename "$file")
#             filepath="${file#./}"
#             if [ "$first" = true ]; then
#               first=false
#             else
#               echo ','
#             fi
#             echo -n "    {\"name\": \"$filename\", \"path\": \"$filepath\"}"
#           done
#           echo ''
#           echo '  ]'
#           echo '}'
#           EOF

#           chmod +x pages/artifacts/generate-list.sh
#           cd pages/artifacts && ./generate-list.sh > artifacts-list.json && cd ../..

#           # Create landing page
#           cat <<EOF > pages/index.html
#           <!DOCTYPE html>
#           <html>
#             <head>
#               <meta charset="UTF-8" />
#               <title>Test Reports</title>
#               <style>
#                 body {
#                   font-family: Arial, sans-serif;
#                   padding: 40px;
#                 }
#                 h1 {
#                   margin-bottom: 10px;
#                 }
#                 ul {
#                   margin-top: 20px;
#                 }
#                 li {
#                   margin: 12px 0;
#                 }
#                 a {
#                   font-size: 18px;
#                   text-decoration: none;
#                   color: #0366d6;
#                 }
#                 a:hover {
#                   text-decoration: underline;
#                 }
#                 small {
#                   color: #555;
#                 }
#               </style>
#             </head>
#             <body>
#               <h1>Test Reports</h1>
#               <p>Select a report:</p>
#               <ul>
#                 <li>
#                   <a href="./allure/">Allure Report</a>
#                   <small>‚Äì trends, history, API data</small>
#                 </li>
#                 <li>
#                   <a href="./playwright/">Playwright HTML Report</a>
#                   <small>‚Äì debugging, traces</small>
#                 </li>
#                 <li>
#                   <a href="./artifacts/">Runtime Artifacts</a>
#                   <small>‚Äì screenshots, videos, traces</small>
#                 </li>
#               </ul>
#             </body>
#           </html>
#           EOF

#       # 1Ô∏è‚É£2Ô∏è‚É£ Upload Pages artifact (ONLY ONCE)
#       - name: Upload Pages artifact
#         if: always()
#         uses: actions/upload-pages-artifact@v3
#         with:
#           path: pages/

#       # 1Ô∏è‚É£3Ô∏è‚É£ Deploy to GitHub Pages
#       - name: Deploy to GitHub Pages
#         if: always()
#         id: deployment
#         uses: actions/deploy-pages@v4


name: Playwright CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # 1Ô∏è‚É£ Checkout repository with full history
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      # Keep existing gh-pages content
      - name: Preserve existing reports
        run: |
          mkdir -p /tmp/gh-pages-backup
          if [ -d "runs" ]; then
            cp -r runs /tmp/gh-pages-backup/ || true
          fi
          if [ -f "index.html" ]; then
            cp index.html /tmp/gh-pages-backup/ || true
          fi

      # Checkout main branch
      - name: Checkout main branch
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4Ô∏è‚É£ Install Playwright browsers
      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      # 5Ô∏è‚É£ Install Allure CLI
      - name: Install Allure CLI
        run: npm install -D allure-commandline

      # 6Ô∏è‚É£ Run Playwright tests
      - name: Run Playwright tests
        run: xvfb-run -a npx playwright test
        continue-on-error: true

      # 7Ô∏è‚É£ Generate Allure HTML report
      - name: Generate Allure report
        if: always()
        run: npx allure-commandline generate results_reports/allure-results --clean -o results_reports/allure-report

      # 8Ô∏è‚É£ Upload Playwright test-results artifacts
      - name: Upload Playwright test-results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results
          path: results_reports/test-results/
          retention-days: 30

      # 8Ô∏è‚É£b Upload custom artifacts (screenshots/videos)
      - name: Upload custom artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: custom-artifacts
          path: artifacts/
          retention-days: 30

      # 9Ô∏è‚É£ Upload Playwright HTML report
      - name: Upload Playwright report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: results_reports/playwright-report/
          retention-days: 30

      # üîü Upload Allure report
      - name: Upload Allure report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: results_reports/allure-report/
          retention-days: 30

      # 1Ô∏è‚É£1Ô∏è‚É£ Prepare timestamped GitHub Pages content
      - name: Prepare Pages content with timestamp
        if: always()
        run: |
          # Generate timestamp for this run
          TIMESTAMP=$(date -u +"%Y-%m-%d_%H-%M-%S")
          RUN_ID="${{ github.run_number }}"
          RUN_DIR="runs/${TIMESTAMP}_run-${RUN_ID}"
          
          echo "Creating run directory: $RUN_DIR"
          
          # Restore previous runs
          mkdir -p pages
          if [ -d "/tmp/gh-pages-backup/runs" ]; then
            cp -r /tmp/gh-pages-backup/runs pages/
          fi
          
          # Create directory structure for this run
          mkdir -p "pages/${RUN_DIR}/playwright"
          mkdir -p "pages/${RUN_DIR}/allure"
          mkdir -p "pages/${RUN_DIR}/artifacts"

          # Copy reports for this run
          cp -r results_reports/playwright-report/* "pages/${RUN_DIR}/playwright/"
          cp -r results_reports/allure-report/* "pages/${RUN_DIR}/allure/"

          # Copy artifacts from root/artifacts/ directory
          if [ -d "artifacts" ]; then
            cp -r artifacts/* "pages/${RUN_DIR}/artifacts/"
          fi

          # Copy test-results if exists
          if [ -d "results_reports/test-results" ]; then
            cp -r results_reports/test-results/* "pages/${RUN_DIR}/artifacts/"
          fi

          # Create artifact index page for this run
          cat <<'ARTIFACT_HTML' > "pages/${RUN_DIR}/artifacts/index.html"
          <!DOCTYPE html>
          <html>
            <head>
              <meta charset="UTF-8" />
              <title>Test Artifacts</title>
              <style>
                body {
                  font-family: Arial, sans-serif;
                  padding: 40px;
                  background: #f5f5f5;
                }
                h1 {
                  margin-bottom: 10px;
                  color: #333;
                }
                .breadcrumb {
                  margin-bottom: 20px;
                  color: #666;
                }
                .breadcrumb a {
                  color: #0366d6;
                  text-decoration: none;
                }
                .breadcrumb a:hover {
                  text-decoration: underline;
                }
                .artifacts-grid {
                  display: grid;
                  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                  gap: 20px;
                  margin-top: 20px;
                }
                .artifact-card {
                  background: white;
                  border-radius: 8px;
                  padding: 15px;
                  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                .artifact-card h3 {
                  margin: 0 0 10px 0;
                  font-size: 14px;
                  color: #666;
                  word-break: break-all;
                }
                .artifact-card img {
                  width: 100%;
                  height: auto;
                  border-radius: 4px;
                  cursor: pointer;
                  transition: transform 0.2s;
                }
                .artifact-card img:hover {
                  transform: scale(1.02);
                }
                .artifact-card video {
                  width: 100%;
                  height: auto;
                  border-radius: 4px;
                }
                .modal {
                  display: none;
                  position: fixed;
                  z-index: 1000;
                  left: 0;
                  top: 0;
                  width: 100%;
                  height: 100%;
                  background-color: rgba(0,0,0,0.9);
                }
                .modal-content {
                  margin: auto;
                  display: block;
                  max-width: 90%;
                  max-height: 90%;
                  position: absolute;
                  top: 50%;
                  left: 50%;
                  transform: translate(-50%, -50%);
                }
                .close {
                  position: absolute;
                  top: 15px;
                  right: 35px;
                  color: #f1f1f1;
                  font-size: 40px;
                  font-weight: bold;
                  cursor: pointer;
                }
                .no-artifacts {
                  text-align: center;
                  color: #999;
                  padding: 40px;
                }
              </style>
            </head>
            <body>
              <div class="breadcrumb">
                <a href="../../..">‚Üê Back to All Runs</a> / 
                <a href="..">This Run</a> / Artifacts
              </div>
              <h1>Test Artifacts</h1>
              <div id="artifacts-container" class="artifacts-grid"></div>
              <div class="no-artifacts" id="no-artifacts" style="display:none;">
                No artifacts found
              </div>

              <div id="imageModal" class="modal">
                <span class="close">&times;</span>
                <img class="modal-content" id="modalImage">
              </div>

              <script>
                async function loadArtifacts() {
                  const container = document.getElementById('artifacts-container');
                  const noArtifacts = document.getElementById('no-artifacts');
                  
                  try {
                    const response = await fetch('artifacts-list.json');
                    const data = await response.json();
                    
                    if (data.screenshots.length === 0 && data.videos.length === 0) {
                      noArtifacts.style.display = 'block';
                      return;
                    }

                    // Display screenshots
                    data.screenshots.forEach(screenshot => {
                      const card = document.createElement('div');
                      card.className = 'artifact-card';
                      card.innerHTML = `
                        <h3>üì∏ ${screenshot.name}</h3>
                        <img src="${screenshot.path}" alt="${screenshot.name}" onclick="openModal(this.src)">
                      `;
                      container.appendChild(card);
                    });

                    // Display videos
                    data.videos.forEach(video => {
                      const card = document.createElement('div');
                      card.className = 'artifact-card';
                      card.innerHTML = `
                        <h3>üé• ${video.name}</h3>
                        <video controls>
                          <source src="${video.path}" type="video/webm">
                          Your browser does not support the video tag.
                        </video>
                      `;
                      container.appendChild(card);
                    });
                  } catch (error) {
                    noArtifacts.style.display = 'block';
                  }
                }

                function openModal(src) {
                  const modal = document.getElementById('imageModal');
                  const modalImg = document.getElementById('modalImage');
                  modal.style.display = 'block';
                  modalImg.src = src;
                }

                document.querySelector('.close').onclick = function() {
                  document.getElementById('imageModal').style.display = 'none';
                }

                window.onclick = function(event) {
                  const modal = document.getElementById('imageModal');
                  if (event.target == modal) {
                    modal.style.display = 'none';
                  }
                }

                loadArtifacts();
              </script>
            </body>
          </html>
          ARTIFACT_HTML

          # Generate artifacts list JSON for this run
          cat <<'LIST_SCRIPT' > "pages/${RUN_DIR}/artifacts/generate-list.sh"
          #!/bin/bash
          cd "$(dirname "$0")"
          
          echo '{'
          echo '  "screenshots": ['
          first=true
          find . -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" \) | while read -r file; do
            filename=$(basename "$file")
            filepath="${file#./}"
            if [ "$first" = true ]; then
              first=false
            else
              echo ','
            fi
            echo -n "    {\"name\": \"$filename\", \"path\": \"$filepath\"}"
          done
          echo ''
          echo '  ],'
          echo '  "videos": ['
          first=true
          find . -type f \( -name "*.webm" -o -name "*.mp4" \) | while read -r file; do
            filename=$(basename "$file")
            filepath="${file#./}"
            if [ "$first" = true ]; then
              first=false
            else
              echo ','
            fi
            echo -n "    {\"name\": \"$filename\", \"path\": \"$filepath\"}"
          done
          echo ''
          echo '  ]'
          echo '}'
          LIST_SCRIPT

          chmod +x "pages/${RUN_DIR}/artifacts/generate-list.sh"
          cd "pages/${RUN_DIR}/artifacts" && ./generate-list.sh > artifacts-list.json && cd ../../..

          # Create run-specific index page
          cat <<RUN_INDEX > "pages/${RUN_DIR}/index.html"
          <!DOCTYPE html>
          <html>
            <head>
              <meta charset="UTF-8" />
              <title>Test Run - ${TIMESTAMP}</title>
              <style>
                body {
                  font-family: Arial, sans-serif;
                  padding: 40px;
                  background: #f5f5f5;
                }
                .container {
                  max-width: 1200px;
                  margin: 0 auto;
                  background: white;
                  padding: 40px;
                  border-radius: 8px;
                  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                .breadcrumb {
                  margin-bottom: 20px;
                  color: #666;
                }
                .breadcrumb a {
                  color: #0366d6;
                  text-decoration: none;
                }
                .breadcrumb a:hover {
                  text-decoration: underline;
                }
                h1 {
                  margin-bottom: 10px;
                  color: #333;
                }
                .run-info {
                  background: #f8f9fa;
                  padding: 15px;
                  border-radius: 4px;
                  margin: 20px 0;
                }
                .run-info p {
                  margin: 5px 0;
                  color: #666;
                }
                ul {
                  margin-top: 30px;
                  list-style: none;
                  padding: 0;
                }
                li {
                  margin: 15px 0;
                }
                a {
                  font-size: 18px;
                  text-decoration: none;
                  color: #0366d6;
                  display: inline-block;
                  padding: 12px 20px;
                  background: #f0f7ff;
                  border-radius: 4px;
                  transition: background 0.2s;
                }
                a:hover {
                  background: #d9ebff;
                }
                small {
                  color: #555;
                  margin-left: 10px;
                }
              </style>
            </head>
            <body>
              <div class="container">
                <div class="breadcrumb">
                  <a href="../..">‚Üê Back to All Runs</a>
                </div>
                <h1>Test Run Reports</h1>
                <div class="run-info">
                  <p><strong>Run Date:</strong> ${TIMESTAMP}</p>
                  <p><strong>Run Number:</strong> #${RUN_ID}</p>
                  <p><strong>Branch:</strong> ${{ github.ref_name }}</p>
                  <p><strong>Commit:</strong> ${{ github.sha }}</p>
                </div>
                <ul>
                  <li>
                    <a href="./allure/">üìä Allure Report</a>
                    <small>Comprehensive test trends and history</small>
                  </li>
                  <li>
                    <a href="./playwright/">üé≠ Playwright Report</a>
                    <small>Interactive test results with traces</small>
                  </li>
                  <li>
                    <a href="./artifacts/">üì¶ Test Artifacts</a>
                    <small>Screenshots, videos, and recordings</small>
                  </li>
                </ul>
              </div>
            </body>
          </html>
          RUN_INDEX

          # Clean up runs older than 30 days
          echo "Cleaning up old runs..."
          find pages/runs -maxdepth 1 -type d -mtime +30 -exec rm -rf {} \; 2>/dev/null || true

          # Generate main index page with all runs
          cat <<'MAIN_INDEX' > pages/index.html
          <!DOCTYPE html>
          <html>
            <head>
              <meta charset="UTF-8" />
              <title>Test Reports - All Runs</title>
              <style>
                body {
                  font-family: Arial, sans-serif;
                  padding: 40px;
                  background: #f5f5f5;
                }
                .container {
                  max-width: 1400px;
                  margin: 0 auto;
                }
                h1 {
                  color: #333;
                  margin-bottom: 10px;
                }
                .subtitle {
                  color: #666;
                  margin-bottom: 30px;
                }
                .latest-run {
                  background: #e7f3ff;
                  border-left: 4px solid #0366d6;
                  padding: 20px;
                  margin-bottom: 30px;
                  border-radius: 4px;
                }
                .latest-run h2 {
                  margin: 0 0 10px 0;
                  color: #0366d6;
                }
                .runs-table {
                  background: white;
                  border-radius: 8px;
                  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                  overflow: hidden;
                }
                table {
                  width: 100%;
                  border-collapse: collapse;
                }
                thead {
                  background: #f8f9fa;
                }
                th {
                  padding: 15px;
                  text-align: left;
                  font-weight: 600;
                  color: #333;
                  border-bottom: 2px solid #dee2e6;
                }
                td {
                  padding: 15px;
                  border-bottom: 1px solid #dee2e6;
                }
                tr:hover {
                  background: #f8f9fa;
                }
                .run-link {
                  color: #0366d6;
                  text-decoration: none;
                  font-weight: 500;
                }
                .run-link:hover {
                  text-decoration: underline;
                }
                .report-links a {
                  display: inline-block;
                  margin-right: 10px;
                  padding: 5px 10px;
                  background: #f0f7ff;
                  color: #0366d6;
                  text-decoration: none;
                  border-radius: 3px;
                  font-size: 14px;
                }
                .report-links a:hover {
                  background: #d9ebff;
                }
                .badge {
                  display: inline-block;
                  padding: 3px 8px;
                  border-radius: 3px;
                  font-size: 12px;
                  font-weight: 500;
                }
                .badge-latest {
                  background: #28a745;
                  color: white;
                }
                .no-runs {
                  text-align: center;
                  padding: 60px;
                  color: #999;
                }
              </style>
            </head>
            <body>
              <div class="container">
                <h1>üß™ Test Reports Dashboard</h1>
                <p class="subtitle">Browse all test runs (retained for 30 days)</p>
                
                <div id="latest-run-section"></div>
                
                <div class="runs-table">
                  <table>
                    <thead>
                      <tr>
                        <th>Run Date & Time</th>
                        <th>Run #</th>
                        <th>Reports</th>
                      </tr>
                    </thead>
                    <tbody id="runs-list">
                      <tr>
                        <td colspan="3" class="no-runs">Loading runs...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <script>
                async function loadRuns() {
                  try {
                    const response = await fetch('runs-list.json');
                    const runs = await response.json();
                    
                    const runsList = document.getElementById('runs-list');
                    const latestSection = document.getElementById('latest-run-section');
                    
                    if (runs.length === 0) {
                      runsList.innerHTML = '<tr><td colspan="3" class="no-runs">No test runs found</td></tr>';
                      return;
                    }

                    // Show latest run
                    const latest = runs[0];
                    latestSection.innerHTML = `
                      <div class="latest-run">
                        <h2>üìç Latest Run</h2>
                        <p><strong>${latest.date}</strong> - Run #${latest.runNumber}</p>
                        <div class="report-links">
                          <a href="${latest.path}">View All Reports</a>
                          <a href="${latest.path}/allure/">Allure</a>
                          <a href="${latest.path}/playwright/">Playwright</a>
                          <a href="${latest.path}/artifacts/">Artifacts</a>
                        </div>
                      </div>
                    `;

                    // Show all runs in table
                    runsList.innerHTML = runs.map((run, index) => `
                      <tr>
                        <td>
                          <a href="${run.path}" class="run-link">${run.date}</a>
                          ${index === 0 ? '<span class="badge badge-latest">LATEST</span>' : ''}
                        </td>
                        <td>#${run.runNumber}</td>
                        <td class="report-links">
                          <a href="${run.path}/allure/">üìä Allure</a>
                          <a href="${run.path}/playwright/">üé≠ Playwright</a>
                          <a href="${run.path}/artifacts/">üì¶ Artifacts</a>
                        </td>
                      </tr>
                    `).join('');
                  } catch (error) {
                    console.error('Error loading runs:', error);
                    document.getElementById('runs-list').innerHTML = 
                      '<tr><td colspan="3" class="no-runs">Error loading runs</td></tr>';
                  }
                }

                loadRuns();
              </script>
            </body>
          </html>
          MAIN_INDEX

          # Generate runs list JSON
          cat <<'RUNS_SCRIPT' > pages/generate-runs-list.sh
          #!/bin/bash
          cd "$(dirname "$0")"
          
          echo '['
          first=true
          
          # Find all run directories, sort by date (newest first)
          find runs -maxdepth 1 -type d -name "*_run-*" | sort -r | while read -r dir; do
            if [ "$first" = true ]; then
              first=false
            else
              echo ','
            fi
            
            dirname=$(basename "$dir")
            # Extract date and run number from dirname
            date_part=$(echo "$dirname" | cut -d'_' -f1-2 | tr '_' ' ')
            run_num=$(echo "$dirname" | grep -oP 'run-\K[0-9]+')
            
            echo -n "  {\"path\": \"$dir\", \"date\": \"$date_part\", \"runNumber\": \"$run_num\"}"
          done
          
          echo ''
          echo ']'
          RUNS_SCRIPT

          chmod +x pages/generate-runs-list.sh
          cd pages && ./generate-runs-list.sh > runs-list.json && cd ..

      # 1Ô∏è‚É£2Ô∏è‚É£ Upload Pages artifact
      - name: Upload Pages artifact
        if: always()
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages/

      # 1Ô∏è‚É£3Ô∏è‚É£ Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        if: always()
        id: deployment
        uses: actions/deploy-pages@v4